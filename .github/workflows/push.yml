name: .NET

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: 10.0.x

    - name: Build
      run: dotnet build src -c Release

    - name: Upload nupkg artifact
      uses: actions/upload-artifact@v4
      with:
        name: nupkg
        path: 'src/InternalsVisibleToPatcher/bin/Release/*.nupkg'
        
    - id: version-check
      name: Version check
      run: |
        proj=src/InternalsVisibleToPatcher/InternalsVisibleToPatcher.csproj
        current=$(grep -oPm1 '(?<=<Version>)[^<]+' "$proj" 2>/dev/null || true)
        previous=$(git show "${{ github.event.before }}":"$proj" 2>/dev/null | grep -oPm1 '(?<=<Version>)[^<]+' || true)
        if [ -n "$current" ] && [ "$current" != "$previous" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Publish to NuGet
      if: ${{ github.event_name == 'push' && steps.version-check.outputs.changed == 'true' }}
      env:
        NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      run: |
        dotnet nuget push src/InternalsVisibleToPatcher/bin/Release/*.nupkg -k "$NUGET_API_KEY" -s https://api.nuget.org/v3/index.json --skip-duplicate
